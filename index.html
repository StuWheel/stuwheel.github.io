<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intellio Shift Launch Leader</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        /* Optional: Custom dice animation for a smoother look */
        .dice-roll-animate {
            animation: bounce 0.5s infinite alternate;
        }
        @keyframes bounce {
            0% { transform: translateY(0); }
            100% { transform: translateY(-5px); }
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-900 to-purple-900 p-4">

    <div id="game-container" class="max-w-7xl mx-auto">
        </div>

    <script>
        // --- Game Configuration & Data (Copied from original TSX) ---
        const SCENARIOS = [
            { id: 1, mechanical: 'Dyonics 2 (S+N)', radiofrequency: 'Werewolf+ (S+N)', baseChance: 66, payoff: 10000, recurringRevenue: 2000, minRep: 1, rollNeeded: [2,3,4,5,6] },
            { id: 2, mechanical: 'Dyonics 2 (S+N)', radiofrequency: 'SynergyRF (Arthrex)', baseChance: 50, payoff: 15000, recurringRevenue: 3000, minRep: 1, rollNeeded: [4,5,6] },
            { id: 3, mechanical: 'Dyonics 2 (S+N)', radiofrequency: 'CrossFire 2 (Stryker)', baseChance: 50, payoff: 15000, recurringRevenue: 3000, minRep: 1, rollNeeded: [4,5,6] },
            { id: 4, mechanical: 'Dyonics 2 (S+N)', radiofrequency: 'Edge (Conmed)', baseChance: 50, payoff: 15000, recurringRevenue: 3000, minRep: 1, rollNeeded: [4,5,6] },
            { id: 5, mechanical: 'SynergyResection (Arthrex)', radiofrequency: 'Werewolf+ (S+N)', baseChance: 50, payoff: 15000, recurringRevenue: 3000, minRep: 1, rollNeeded: [4,5,6] },
            { id: 6, mechanical: 'Core 2 (Stryker)', radiofrequency: 'Werewolf+ (S+N)', baseChance: 50, payoff: 15000, recurringRevenue: 3000, minRep: 1, rollNeeded: [4,5,6] },
            { id: 7, mechanical: 'D4000 (Conmed)', radiofrequency: 'Werewolf+ (S+N)', baseChance: 50, payoff: 15000, recurringRevenue: 3000, minRep: 1, rollNeeded: [4,5,6] },
            { id: 8, mechanical: 'SynergyResection (Arthrex)', radiofrequency: 'SynergyRF (Arthrex)', baseChance: 33, payoff: 20000, recurringRevenue: 4000, minRep: 1, rollNeeded: [5,6] },
            { id: 9, mechanical: 'SynergyResection (Arthrex)', radiofrequency: 'CrossFire 2 (Stryker)', baseChance: 33, payoff: 20000, recurringRevenue: 4000, minRep: 1, rollNeeded: [5,6] },
            { id: 10, mechanical: 'SynergyResection (Arthrex)', radiofrequency: 'Edge (Conmed)', baseChance: 33, payoff: 20000, recurringRevenue: 4000, minRep: 1, rollNeeded: [5,6] },
            { id: 11, mechanical: 'Core 2 (Stryker)', radiofrequency: 'SynergyRF (Arthrex)', baseChance: 33, payoff: 20000, recurringRevenue: 4000, minRep: 1, rollNeeded: [5,6] },
            { id: 12, mechanical: 'Core 2 (Stryker)', radiofrequency: 'CrossFire 2 (Stryker)', baseChance: 33, payoff: 20000, recurringRevenue: 4000, minRep: 1, rollNeeded: [5,6] },
            { id: 13, mechanical: 'Core 2 (Stryker)', radiofrequency: 'Edge (Conmed)', baseChance: 33, payoff: 20000, recurringRevenue: 4000, minRep: 1, rollNeeded: [5,6] },
            { id: 14, mechanical: 'D4000 (Conmed)', radiofrequency: 'SynergyRF (Arthrex)', baseChance: 33, payoff: 20000, recurringRevenue: 4000, minRep: 1, rollNeeded: [5,6] },
            { id: 15, mechanical: 'D4000 (Conmed)', radiofrequency: 'CrossFire 2 (Stryker)', baseChance: 33, payoff: 20000, recurringRevenue: 4000, minRep: 1, rollNeeded: [5,6] },
            { id: 16, mechanical: 'D4000 (Conmed)', radiofrequency: 'Edge (Conmed)', baseChance: 16, payoff: 30000, recurringRevenue: 6000, minRep: 2, rollNeeded: [6] }
        ];

        const TRIAL_COST = 5000;
        const ACCOUNT_NAMES = [
            'Apex Health', 'Summit Medical', 'Pinnacle Care', 'Horizon Systems', 'Vertex Solutions',
            'Nexus Corp', 'Meridian Health', 'Zenith Medical', 'Atlas Healthcare', 'Titan Industries',
            'Phoenix Medical', 'Quantum Health', 'Vanguard Systems', 'Eclipse Healthcare', 'Infinity Corp'
        ];
        const TARGET_REVENUE = 100000;
        const STARTING_REP = 5;

        // --- Game State Variables ---
        let gameState = null;
        let playerId = localStorage.getItem('launchLeaderPlayerId') || '';
        let playerName = '';
        let joinName = '';
        let selectedAccountId = null;
        let repToCommit = 1;
        let message = '';
        let diceRoll = null;
        let rolling = false;

        // --- Utility Functions (DOM/Icon) ---

        // Simple function to convert Lucide icon name to SVG markup
        const icon = (name, className = 'w-4 h-4', stroke = 'currentColor') => {
            const IconComponent = lucide.createIcons()[name];
            if (!IconComponent) return '';
            return IconComponent.toSvg({ class: className, stroke: stroke });
        };

        const render = () => {
            const container = document.getElementById('game-container');
            if (!container) return;
            
            if (!playerId || !gameState) {
                container.innerHTML = renderLobby();
                attachLobbyListeners();
            } else {
                container.innerHTML = renderGame();
                attachGameListeners();
            }
            
            // Re-render icons after HTML insertion
            lucide.createIcons();
        };

        // --- Game Logic Refactor (Using localStorage) ---

        const GAME_STORAGE_KEY = 'launch-leader-game';

        const loadGame = () => {
            const storedState = localStorage.getItem(GAME_STORAGE_KEY);
            if (storedState) {
                gameState = JSON.parse(storedState);
            }
            render();
        };

        const saveGame = (newState) => {
            gameState = newState;
            localStorage.setItem(GAME_STORAGE_KEY, JSON.stringify(newState));
            render();
        };

        const generateAccounts = () => {
            const accounts = [];
            const shuffledNames = [...ACCOUNT_NAMES].sort(() => Math.random() - 0.5);
            
            for (let i = 0; i < 20; i++) {
                const scenario = SCENARIOS[Math.floor(Math.random() * SCENARIOS.length)];
                accounts.push({
                    id: `account_${i}`,
                    name: shuffledNames[i % ACCOUNT_NAMES.length] + (i >= ACCOUNT_NAMES.length ? ` ${Math.floor(i / ACCOUNT_NAMES.length) + 1}` : ''),
                    scenario: scenario.id,
                    mechanical: scenario.mechanical,
                    radiofrequency: scenario.radiofrequency,
                    baseChance: scenario.baseChance,
                    payoff: scenario.payoff,
                    recurringRevenue: scenario.recurringRevenue,
                    minRep: scenario.minRep,
                    rollNeeded: scenario.rollNeeded,
                    available: true,
                    ownedBy: null
                });
            }
            return accounts;
        };

        const getCurrentPlayer = () => {
            if (!gameState || !gameState.players || !gameState.players.length) return null;
            return gameState.players[gameState.currentPlayerIndex];
        };

        const getMyPlayer = () => {
            if (!gameState || !gameState.players || !playerId) return null;
            return gameState.players.find(p => p.id === playerId);
        };

        const isMyTurn = () => {
            const current = getCurrentPlayer();
            return current && current.id === playerId && !gameState.winner;
        };

        // --- Action Handlers ---

        const createGame = () => {
            if (!playerName.trim()) return;
            
            const newPlayerId = `player_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            const accounts = generateAccounts();
            
            const newGame = {
                players: [{
                    id: newPlayerId,
                    name: playerName.trim(),
                    rep: STARTING_REP,
                    revenue: 0
                }],
                accounts,
                currentPlayerIndex: 0,
                winner: null,
                createdAt: Date.now()
            };

            saveGame(newGame);
            playerId = newPlayerId;
            localStorage.setItem('launchLeaderPlayerId', newPlayerId);
            message = `Game created! Share this page with others to join.`;
            render();
        };

        const joinGame = () => {
            if (!joinName.trim() || !gameState) return;
            
            const newPlayerId = `player_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            
            const updatedGame = {
                ...gameState,
                players: [...gameState.players, {
                    id: newPlayerId,
                    name: joinName.trim(),
                    rep: STARTING_REP,
                    revenue: 0
                }]
            };

            saveGame(updatedGame);
            playerId = newPlayerId;
            localStorage.setItem('launchLeaderPlayerId', newPlayerId);
            message = `Joined game as ${joinName}!`;
            render();
        };

        const gainRep = () => {
            if (!isMyTurn()) return;
            
            const myPlayer = getMyPlayer();
            
            const myAccounts = gameState.accounts.filter(a => a.ownedBy === playerId);
            const recurringRevenue = myAccounts.reduce((sum, acc) => sum + acc.recurringRevenue, 0);
            
            const updatedPlayers = gameState.players.map(p => 
                p.id === playerId ? { ...p, rep: p.rep + 2, revenue: p.revenue + recurringRevenue } : p
            );
            
            const nextPlayerIndex = (gameState.currentPlayerIndex + 1) % gameState.players.length;
            
            saveGame({
                ...gameState,
                players: updatedPlayers,
                currentPlayerIndex: nextPlayerIndex
            });
            
            if (recurringRevenue > 0) {
                message = `You focused and gained 2 Rep Presence! Also earned ${recurringRevenue.toLocaleString()} from your ${myAccounts.length} account(s).`;
            } else {
                message = 'You focused and gained 2 Rep Presence!';
            }
            selectedAccountId = null;
            repToCommit = 1;
            render();
        };

        const attemptTrial = () => {
            if (!isMyTurn() || !selectedAccountId || rolling) return;
            
            const account = gameState.accounts.find(a => a.id === selectedAccountId);
            const myPlayer = getMyPlayer();
            
            if (!account || !account.available) {
                message = 'This account is no longer available';
                render();
                return;
            }
            
            if (!myPlayer) {
                message = 'Player not found';
                render();
                return;
            }
            
            if (repToCommit < account.minRep) {
                message = `This account requires at least ${account.minRep} Rep Presence`;
                render();
                return;
            }
            
            if (myPlayer.rep < repToCommit) {
                message = 'Not enough Rep Presence tokens';
                render();
                return;
            }

            rolling = true;
            message = 'Rolling dice...';
            render();
            
            // Animate dice roll
            let count = 0;
            const rollInterval = setInterval(() => {
                diceRoll = Math.floor(Math.random() * 6) + 1;
                render(); // Render with new dice value
                count++;
                if (count > 10) {
                    clearInterval(rollInterval);
                    finalizeTrial(account, myPlayer);
                }
            }, 100);
        };

        const finalizeTrial = (account, myPlayer) => {
            const finalRoll = Math.floor(Math.random() * 6) + 1;
            diceRoll = finalRoll;
            
            // Calculate success
            const extraRep = repToCommit - account.minRep;
            let successRolls = [...account.rollNeeded];
            
            // Each extra rep adds one more success number
            for (let i = 0; i < extraRep && successRolls.length < 5; i++) {
                const lowestNotIncluded = [1,2,3,4,5].find(n => !successRolls.includes(n));
                if (lowestNotIncluded) {
                    successRolls.push(lowestNotIncluded);
                }
            }
            
            const success = successRolls.includes(finalRoll);
            
            // Update game state - subtract trial cost and add payoff if successful
            const updatedPlayers = gameState.players.map(p => {
                if (p.id === playerId) {
                    return {
                        ...p,
                        rep: p.rep - repToCommit,
                        revenue: success 
                            ? p.revenue + account.payoff - TRIAL_COST 
                            : p.revenue - TRIAL_COST
                    };
                }
                return p;
            });
            
            let updatedAccounts = gameState.accounts;
            if (success) {
                updatedAccounts = gameState.accounts.map(a => 
                    a.id === account.id ? { ...a, available: false, ownedBy: playerId } : a
                );
            }
            
            const newRevenue = updatedPlayers.find(p => p.id === playerId).revenue;
            
            const winner = newRevenue >= TARGET_REVENUE 
                ? playerId 
                : gameState.winner;
            
            const nextPlayerIndex = (gameState.currentPlayerIndex + 1) % gameState.players.length;
            
            saveGame({
                ...gameState,
                players: updatedPlayers,
                accounts: updatedAccounts,
                currentPlayerIndex: nextPlayerIndex,
                winner
            });
            
            if (success) {
                message = `SUCCESS! Rolled ${finalRoll}. Earned ${account.payoff.toLocaleString()} (minus ${TRIAL_COST.toLocaleString()} trial cost)!`;
            } else {
                message = `Failed. Rolled ${finalRoll}. Needed: ${successRolls.join(', ')}. Lost ${TRIAL_COST.toLocaleString()} trial cost.`;
            }
            
            rolling = false;
            selectedAccountId = null;
            repToCommit = 1;
            
            render();
            
            setTimeout(() => {
                diceRoll = null;
                render();
            }, 3000);
        };

        const resetGame = () => {
            localStorage.removeItem(GAME_STORAGE_KEY);
            gameState = null;
            playerId = '';
            playerName = '';
            joinName = '';
            localStorage.removeItem('launchLeaderPlayerId');
            message = 'Game reset!';
            render();
        };

        const leaveGame = () => {
            playerId = '';
            localStorage.removeItem('launchLeaderPlayerId');
            message = 'Left game';
            render();
        };

        const selectAccount = (id) => {
            if (!isMyTurn() || rolling) return;
            selectedAccountId = id;
            const account = gameState.accounts.find(a => a.id === id);
            if (account) {
                repToCommit = account.minRep || 1;
            }
            render();
        };
        
        const updateRepCommit = (value) => {
            repToCommit = parseInt(value);
            render();
        };

        // --- HTML Rendering Functions ---

        const renderLobby = () => {
            const currentPlayersHtml = gameState ? gameState.players.map((p) => `
                <div class="flex items-center gap-2">
                    ${icon('Users', 'w-4 h-4')}
                    <span class="font-medium">${p.name}</span>
                </div>
            `).join('') : '';

            const isGameAvailable = !!gameState;

            return `
                <div class="max-w-2xl mx-auto">
                    <div class="bg-white rounded-lg shadow-2xl p-8 mt-8">
                        <div class="flex items-center gap-3 mb-6">
                            ${icon('TrendingUp', 'w-12 h-12 text-blue-600')}
                            <h1 class="text-4xl font-bold text-gray-800">Intellio Shift Launch Leader</h1>
                        </div>
                        
                        <p class="text-gray-600 mb-8">
                            Be the first to reach $${(TARGET_REVENUE/1000).toFixed(0)}K in revenue by running successful Intellio Shift trials! Each trial costs $${(TRIAL_COST/1000).toFixed(0)}K.
                        </p>

                        ${!isGameAvailable ? `
                            <div class="space-y-4">
                                <h2 class="text-2xl font-semibold text-gray-700">Create New Game</h2>
                                <input
                                    type="text"
                                    id="create-name-input"
                                    placeholder="Your name"
                                    value="${playerName}"
                                    maxlength="20"
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-lg"
                                />
                                <button
                                    id="create-game-btn"
                                    disabled
                                    class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold text-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                                >
                                    ${icon('PlayCircle', 'w-6 h-6')}
                                    Create Game
                                </button>
                            </div>
                        ` : `
                            <div class="space-y-4">
                                <h2 class="text-2xl font-semibold text-gray-700">Join Game</h2>
                                <div class="bg-blue-50 p-4 rounded-lg mb-4">
                                    <p class="text-sm text-gray-600 mb-2">Current Players:</p>
                                    ${currentPlayersHtml}
                                </div>
                                <input
                                    type="text"
                                    id="join-name-input"
                                    placeholder="Your name"
                                    value="${joinName}"
                                    maxlength="20"
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-lg"
                                />
                                <button
                                    id="join-game-btn"
                                    disabled
                                    class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold text-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                                >
                                    ${icon('Users', 'w-6 h-6')}
                                    Join Game
                                </button>
                            </div>
                        `}

                        ${message ? `
                            <div class="mt-4 p-4 bg-blue-50 text-blue-800 rounded-lg">
                                ${message}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        };

        const attachLobbyListeners = () => {
            const createNameInput = document.getElementById('create-name-input');
            const createBtn = document.getElementById('create-game-btn');
            const joinNameInput = document.getElementById('join-name-input');
            const joinBtn = document.getElementById('join-game-btn');

            if (createNameInput) {
                createNameInput.oninput = (e) => {
                    playerName = e.target.value;
                    createBtn.disabled = !playerName.trim();
                };
                createBtn.onclick = createGame;
            }

            if (joinNameInput) {
                joinNameInput.oninput = (e) => {
                    joinName = e.target.value;
                    joinBtn.disabled = !joinName.trim();
                };
                joinBtn.onclick = joinGame;
            }
        };

        const renderGame = () => {
            const currentPlayer = getCurrentPlayer();
            const myPlayer = getMyPlayer();
            const availableAccounts = gameState.accounts.filter(a => a.available);
            const selectedAccountData = selectedAccountId ? gameState.accounts.find(a => a.id === selectedAccountId) : null;
            const isMyCurrentTurn = isMyTurn();

            const playersHtml = gameState.players.map((player, idx) => {
                const isCurrent = idx === gameState.currentPlayerIndex;
                const isMe = player.id === playerId;
                const progressWidth = Math.min(100, ((player.revenue || 0) / TARGET_REVENUE) * 100);

                return `
                    <div 
                        class="bg-white rounded-lg shadow-lg p-4 ${isCurrent ? 'ring-4 ring-yellow-400' : ''} ${isMe ? 'ring-2 ring-blue-400' : ''}"
                    >
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                ${icon('Users', 'w-5 h-5 text-gray-600')}
                                <span class="font-bold text-gray-800">${player.name}</span>
                            </div>
                            ${isCurrent ? '<span class="text-yellow-600 font-bold">â–¶</span>' : ''}
                        </div>
                        <div class="space-y-1 text-sm">
                            <div class="flex items-center gap-2">
                                ${icon('Briefcase', 'w-4 h-4 text-blue-600')}
                                <span>Rep: ${player.rep || 0}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                ${icon('DollarSign', 'w-4 h-4 text-green-600')}
                                <span class="${(player.revenue || 0) < 0 ? 'text-red-600 font-bold' : ''}">$${(player.revenue || 0).toLocaleString()}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                <div 
                                    class="bg-green-600 h-2 rounded-full transition-all"
                                    style="width: ${progressWidth}%"
                                />
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            const turnActionsHtml = isMyCurrentTurn ? `
                <div class="bg-white rounded-lg shadow-lg p-6 mb-4">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Your Turn</h2>
                    <div class="flex gap-4 flex-wrap">
                        <button
                            id="gain-rep-btn"
                            class="px-6 py-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 flex items-center gap-2"
                        >
                            ${icon('Briefcase', 'w-5 h-5')}
                            Focus (Gain 2 Rep, Skip Trial)
                        </button>
                        ${selectedAccountId ? `
                            <button
                                id="attempt-trial-btn"
                                ${rolling || (selectedAccountData && myPlayer.rep < repToCommit) ? 'disabled' : ''}
                                class="px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center gap-2"
                            >
                                ${icon('Dices', 'w-5 h-5')}
                                ${rolling ? 'Rolling...' : 'Launch Trial'}
                            </button>
                        ` : ''}
                    </div>
                    ${message ? `
                        <div class="mt-4 p-4 rounded-lg ${message.includes('SUCCESS') ? 'bg-green-100 text-green-800' : message.includes('Failed') ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'}">
                            ${message}
                        </div>
                    ` : ''}
                    ${diceRoll !== null ? `
                        <div class="mt-4 text-center">
                            <div class="inline-block bg-white border-4 border-gray-800 rounded-lg p-8 text-6xl font-bold ${rolling ? 'dice-roll-animate' : ''}">
                                ${diceRoll}
                            </div>
                        </div>
                    ` : ''}
                </div>
            ` : '';

            const selectedDetailsHtml = selectedAccountData && isMyCurrentTurn && myPlayer ? `
                <div class="bg-white rounded-lg shadow-lg p-6 mb-4">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Trial Configuration for ${selectedAccountData.name}</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-600">Minimum Rep: ${selectedAccountData.minRep || 0}</p>
                            <p class="text-sm text-gray-600">Base Success: ${selectedAccountData.baseChance || 0}%</p>
                            <p class="text-sm text-gray-600">Rolls needed for success: ${selectedAccountData.rollNeeded ? selectedAccountData.rollNeeded.join(', ') : 'N/A'}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Commit Rep Presence: <span id="rep-commit-value">${repToCommit}</span>
                            </label>
                            <input
                                type="range"
                                id="rep-commit-slider"
                                min="${selectedAccountData.minRep || 1}"
                                max="${Math.min(myPlayer.rep || 1, (selectedAccountData.minRep || 1) + 4)}"
                                value="${repToCommit}"
                                class="w-full"
                            />
                            <p class="text-sm text-gray-600 mt-2">
                                Extra Rep: +${(repToCommit - (selectedAccountData.minRep || 0)) * 10}% chance
                            </p>
                        </div>
                    </div>
                </div>
            ` : '';

            const availableAccountsHtml = availableAccounts.map(account => {
                const isSelected = selectedAccountId === account.id;
                return `
                    <div
                        data-account-id="${account.id}"
                        class="account-card border-2 rounded-lg p-4 cursor-pointer transition-all 
                        ${isSelected ? 'border-blue-600 bg-blue-50' : 'border-gray-300 hover:border-blue-400'} 
                        ${!isMyCurrentTurn || rolling ? 'opacity-50 cursor-not-allowed' : ''}"
                    >
                        <h3 class="font-bold text-lg text-gray-800 mb-2">${account.name}</h3>
                        <div class="space-y-1 text-sm text-gray-600">
                            <p><strong>Mechanical:</strong> ${account.mechanical}</p>
                            <p><strong>RF:</strong> ${account.radiofrequency}</p>
                            <p><strong>Success:</strong> ${account.baseChance}%</p>
                            <p class="text-green-600 font-bold text-lg">$${account.payoff.toLocaleString()}</p>
                            <p class="text-blue-600 font-semibold">+ $${account.recurringRevenue.toLocaleString()}/turn</p>
                            <p><strong>Min Rep:</strong> ${account.minRep}</p>
                        </div>
                    </div>
                `;
            }).join('');

            const ownedAccountsHtml = gameState.accounts.filter(a => a.ownedBy).map(account => {
                const owner = gameState.players.find(p => p.id === account.ownedBy);
                const isMine = account.ownedBy === playerId;
                return `
                    <div
                        class="border-2 rounded-lg p-4 ${isMine ? 'border-green-600 bg-green-50' : 'border-gray-300 bg-gray-50'}"
                    >
                        <h3 class="font-bold text-lg text-gray-800 mb-2">${account.name}</h3>
                        <div class="space-y-1 text-sm text-gray-600">
                            <p><strong>Owner:</strong> ${owner?.name}</p>
                            <p><strong>Mechanical:</strong> ${account.mechanical}</p>
                            <p><strong>RF:</strong> ${account.radiofrequency}</p>
                            <p class="text-blue-600 font-semibold">+ $${account.recurringRevenue.toLocaleString()}/turn</p>
                        </div>
                    </div>
                `;
            }).join('');


            return `
                <div class="bg-white rounded-lg shadow-lg p-6 mb-4">
                    <div class="flex items-center justify-between flex-wrap gap-4">
                        <div class="flex items-center gap-3">
                            ${icon('TrendingUp', 'w-8 h-8 text-blue-600')}
                            <h1 class="text-3xl font-bold text-gray-800">Intellio Shift Launch Leader</h1>
                        </div>
                        <div class="flex gap-2">
                            <button id="leave-game-btn" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 flex items-center gap-2">
                                ${icon('LogOut', 'w-4 h-4')}
                                Leave
                            </button>
                            <button id="reset-game-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center gap-2">
                                ${icon('RefreshCw', 'w-4 h-4')}
                                Reset
                            </button>
                        </div>
                    </div>
                </div>

                ${gameState.winner ? `
                    <div class="bg-yellow-400 text-gray-900 rounded-lg shadow-lg p-6 mb-4 text-center">
                        <h2 class="text-3xl font-bold">ðŸŽ‰ ${gameState.players.find(p => p.id === gameState.winner)?.name} Wins! ðŸŽ‰</h2>
                        <p class="text-xl mt-2">Target revenue reached!</p>
                    </div>
                ` : ''}

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    ${playersHtml}
                </div>

                ${turnActionsHtml}

                ${selectedDetailsHtml}

                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Available Accounts (${availableAccounts.length})</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                        ${availableAccountsHtml}
                    </div>
                </div>

                ${gameState.accounts.filter(a => a.ownedBy).length > 0 ? `
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Won Accounts</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                            ${ownedAccountsHtml}
                        </div>
                    </div>
                ` : ''}
            `;
        };

        const attachGameListeners = () => {
            document.getElementById('leave-game-btn').onclick = leaveGame;
            document.getElementById('reset-game-btn').onclick = resetGame;

            if (isMyTurn()) {
                const gainRepBtn = document.getElementById('gain-rep-btn');
                if (gainRepBtn) gainRepBtn.onclick = gainRep;

                const attemptTrialBtn = document.getElementById('attempt-trial-btn');
                if (attemptTrialBtn) attemptTrialBtn.onclick = attemptTrial;

                const repSlider = document.getElementById('rep-commit-slider');
                if (repSlider) {
                    repSlider.oninput = (e) => {
                        updateRepCommit(e.target.value);
                    };
                }
            }

            document.querySelectorAll('.account-card').forEach(card => {
                card.onclick = () => {
                    selectAccount(card.getAttribute('data-account-id'));
                };
            });
        };

        // --- Initialization ---
        
        // Initial load and setup recurring check
        loadGame();
        setInterval(loadGame, 3000); // Poll for game updates for multi-player experience

    </script>
</body>
</html>